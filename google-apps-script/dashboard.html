<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradebook System Dashboard | 成績簿系統控制台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 2rem;
            margin-right: 15px;
            padding: 15px;
            border-radius: 10px;
            color: white;
        }

        .system-status .card-icon { background: #4CAF50; }
        .quick-stats .card-icon { background: #2196F3; }
        .system-controls .card-icon { background: #FF9800; }
        .progress-overview .card-icon { background: #9C27B0; }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #666;
        }

        .stat-value {
            font-weight: 600;
            color: #333;
            padding: 5px 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Assessment Title Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 0;
            border: none;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .class-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .class-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .class-info h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }

        .class-info p {
            margin: 5px 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .assessment-section {
            margin-bottom: 20px;
        }

        .assessment-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1rem;
        }

        .assessment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .assessment-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .assessment-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn-update {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn-update:hover {
            background: #0056b3;
        }

        .btn-reset {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .btn-reset:hover {
            background: #c82333;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 10px;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-excellent { background: #4CAF50; }
        .status-good { background: #FFC107; }
        .status-warning { background: #FF9800; }
        .status-error { background: #f44336; }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .bilingual {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* Assessment Title Manager Styles */
        .assessment-form {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .form-section {
            margin-bottom: 20px;
        }
        
        .form-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal !important;
        }
        
        .radio-label input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .result-section {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .result-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .result-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Progress Audit Modal Styles */
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #007bff;
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 0 5px 5px 5px;
            min-height: 200px;
        }
        
        .level-groups {
            display: grid;
            gap: 20px;
        }
        
        .level-group {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .level-group h4 {
            margin: 0 0 15px 0;
            color: #007bff;
            font-size: 1.2em;
        }
        
        .assessment-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .assessment-type {
            background: white;
            padding: 12px;
            border-radius: 5px;
        }
        
        .assessment-type strong {
            display: block;
            margin-bottom: 10px;
            color: #495057;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .checkbox-group input[type="checkbox"] {
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .assessment-form {
                max-width: 100%;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* Progress Audit Loading Indicator */
        .loading-indicator {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .loading-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #6c757d;
        }
        
        .loading-content i {
            font-size: 1.2rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Progress Audit Messages */
        .progress-audit-message {
            padding: 12px 16px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .progress-audit-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .progress-audit-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Progress Results Display */
        .progress-results {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        
        .progress-audit-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .progress-audit-summary h4 {
            margin: 0 0 15px 0;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 8px;
        }
        
        .audit-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        /* Diagnostic Section Styles */
        .diagnostic-section {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }
        
        .diagnostic-section h5 {
            margin: 0 0 15px 0;
            color: #17a2b8;
            font-weight: 600;
        }
        
        .diagnostic-section h6 {
            margin: 15px 0 8px 0;
            color: #495057;
            font-weight: 500;
        }
        
        .diagnostic-steps {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
        }
        
        .diagnostic-steps li {
            padding: 6px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .success-step {
            background: #d4edda;
            color: #155724;
            border-left: 3px solid #28a745;
        }
        
        .warning-step {
            background: #fff3cd;
            color: #856404;
            border-left: 3px solid #ffc107;
        }
        
        .error-step {
            background: #f8d7da;
            color: #721c24;
            border-left: 3px solid #dc3545;
        }
        
        .diagnostic-details ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .diagnostic-details ul li {
            margin: 4px 0;
            padding: 2px 0;
        }
        
        .error-list {
            list-style: none;
            padding: 0;
        }
        
        .error-list li {
            background: #f8d7da;
            color: #721c24;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid #dc3545;
        }
        
        .audit-meta p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .progress-results-table {
            overflow-x: auto;
        }
        
        .progress-results table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .progress-results th,
        .progress-results td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .progress-results th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .progress-results tr:hover {
            background-color: #f8f9fa;
        }
        
        .level-group-breakdown {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        
        .level-group-breakdown h5 {
            color: #495057;
            margin-bottom: 15px;
        }
        
        .level-group-item {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        
        .level-group-item h6 {
            margin: 0 0 5px 0;
            font-weight: 600;
            color: #495057;
        }
        
        .level-group-item p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📊 Gradebook System Dashboard</h1>
            <p>Educational grade management system</p>
            <div class="bilingual">Complete Google-based gradebook solution</div>
        </div>

        <!-- Alert Messages -->
        <div id="alert-success" class="alert alert-success"></div>
        <div id="alert-error" class="alert alert-error"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- System Status Card -->
            <div class="card system-status">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div>
                        <div class="card-title">System Status</div>
                        <div class="bilingual">Real-time system health monitoring</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">System Health</span>
                    <span class="stat-value">
                        <span class="status-indicator status-excellent"></span>
                        Excellent
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Updated</span>
                    <span class="stat-value" id="last-updated">Loading...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Semester</span>
                    <span class="stat-value">2526F1</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Version</span>
                    <span class="stat-value">Dashboard v3.0</span>
                </div>
            </div>

            <!-- Quick Statistics Card -->
            <div class="card quick-stats">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div>
                        <div class="card-title">Quick Statistics</div>
                        <div class="bilingual">Real-time system metrics</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Teachers</span>
                    <span class="stat-value" id="total-teachers">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Students</span>
                    <span class="stat-value" id="total-students">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Active Gradebooks</span>
                    <span class="stat-value" id="active-gradebooks">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">System Files</span>
                    <span class="stat-value" id="system-files">0</span>
                </div>
            </div>

            <!-- System Controls Card -->
            <div class="card system-controls">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <div class="card-title">System Controls</div>
                        <div class="bilingual">One-click system management</div>
                    </div>
                </div>
                <div class="control-grid">
                    <button class="btn btn-primary" onclick="initializeSystem()">
                        <i class="fas fa-rocket"></i> Initialize System
                    </button>
                    <button class="btn btn-secondary" onclick="checkSystemStatus()">
                        <i class="fas fa-stethoscope"></i> Check Status
                    </button>
                    <button class="btn btn-warning" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh Dashboard
                    </button>
                    <button class="btn btn-secondary" onclick="openSystemFolder()">
                        <i class="fas fa-folder-open"></i> System Folder
                    </button>
                    <button class="btn btn-info" onclick="openMasterData()">
                        <i class="fas fa-database"></i> Master Data
                    </button>
                    <button class="btn btn-success" onclick="manageAssessmentTitles()">
                        <i class="fas fa-tags"></i> Assessment Titles
                    </button>
                    <button class="btn btn-danger" onclick="systemBackup()">
                        <i class="fas fa-download"></i> System Backup
                    </button>
                    <button class="btn btn-info" onclick="testSystemIntegrity()">
                        <i class="fas fa-check-circle"></i> Test System
                    </button>
                    <button class="btn btn-warning" onclick="performQualityCheck()">
                        <i class="fas fa-search"></i> /check Quality
                    </button>
                    <button class="btn btn-success" onclick="openResourceManager()">
                        <i class="fas fa-plus-circle"></i> Add Resource
                    </button>
                    <button class="btn btn-primary" onclick="openHTDashboard()">
                        <i class="fas fa-user-tie"></i> HT Dashboard
                    </button>
                    <button class="btn btn-warning" onclick="openProgressAudit()">
                        <i class="fas fa-clipboard-check"></i> Progress Audit | 進度稽核
                    </button>
                </div>
            </div>

            <!-- Progress Overview Card -->
            <div class="card progress-overview">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div>
                        <div class="card-title">Progress Overview</div>
                        <div class="bilingual">Teacher progress tracking</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🟢 Excellent (≥90%)</span>
                    <span class="stat-value" id="progress-excellent">0 (0%)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🟡 Good (80-89%)</span>
                    <span class="stat-value" id="progress-good">0 (0%)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🟠 Normal (60-79%)</span>
                    <span class="stat-value" id="progress-normal">0 (0%)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🔴 Behind (<60%)</span>
                    <span class="stat-value" id="progress-behind">0 (0%)</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 75%;"></div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <small>Overall System Progress: <span id="overall-percentage">75%</span></small>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon" style="background: #607D8B;">
                    <i class="fas fa-bolt"></i>
                </div>
                <div>
                    <div class="card-title">Quick Actions</div>
                    <div class="bilingual">Frequently used system functions</div>
                </div>
            </div>
            <div class="control-grid">
                <button class="btn btn-primary" onclick="batchCreateGradebooks()">
                    <i class="fas fa-plus-circle"></i> Batch Create Gradebooks
                </button>
                <button class="btn btn-warning" onclick="quickProgressCheck()">
                    <i class="fas fa-tachometer-alt"></i> Quick Progress Check
                </button>
                <button class="btn btn-info" onclick="openProgressStandardsDialog()">
                    <i class="fas fa-cogs"></i> Custom Progress Check
                </button>
                <button class="btn btn-warning" onclick="generateReport()">
                    <i class="fas fa-file-alt"></i> Generate Report
                </button>
                <button class="btn btn-secondary" onclick="importStudentData()">
                    <i class="fas fa-upload"></i> Import Student Data
                </button>
                <button class="btn btn-secondary" onclick="exportStudentData()">
                    <i class="fas fa-download"></i> Export Student Data
                </button>
                <button class="btn btn-warning" onclick="systemMaintenance()">
                    <i class="fas fa-tools"></i> System Maintenance
                </button>
                <button class="btn btn-success" onclick="openAssessmentTitleManager()">
                    <i class="fas fa-edit"></i> Assessment Title Manager
                </button>
            </div>
        </div>
    </div>

    <!-- Assessment Title Management Modal -->
    <div id="assessmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-tags"></i> Assessment Title Management</h2>
                <span class="close" onclick="closeAssessmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="assessment-content">
                    <div class="assessment-form">
                        <div class="form-section">
                            <label for="classSelect"><i class="fas fa-school"></i> Class | 班級:</label>
                            <select id="classSelect" class="form-control">
                                <option value="">Select Class | 選擇班級</option>
                                <option value="G1E1">G1E1</option>
                                <option value="G1E2">G1E2</option>
                                <option value="G1E3">G1E3</option>
                                <option value="G2E1">G2E1</option>
                                <option value="G2E2">G2E2</option>
                                <option value="G2E3">G2E3</option>
                                <option value="G3E1">G3E1</option>
                                <option value="G3E2">G3E2</option>
                                <option value="G3E3">G3E3</option>
                                <option value="G4E1">G4E1</option>
                                <option value="G4E2">G4E2</option>
                                <option value="G4E3">G4E3</option>
                                <option value="G5E1">G5E1</option>
                                <option value="G5E2">G5E2</option>
                                <option value="G5E3">G5E3</option>
                                <option value="G6E1">G6E1</option>
                                <option value="G6E2">G6E2</option>
                                <option value="G6E3">G6E3</option>
                            </select>
                        </div>
                        
                        <div class="form-section">
                            <label><i class="fas fa-book"></i> Subject | 科目:</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="subject" value="LT"> LT (Language Teacher)
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="subject" value="IT"> IT (International Teacher)
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <label for="assessmentSelect"><i class="fas fa-clipboard-check"></i> Assessment | 評量:</label>
                            <select id="assessmentSelect" class="form-control">
                                <option value="">Select Assessment | 選擇評量</option>
                                <optgroup label="Formative Assessments | 形成性評量">
                                    <option value="F.A.1">F.A.1</option>
                                    <option value="F.A.2">F.A.2</option>
                                    <option value="F.A.3">F.A.3</option>
                                    <option value="F.A.4">F.A.4</option>
                                    <option value="F.A.5">F.A.5</option>
                                    <option value="F.A.6">F.A.6</option>
                                    <option value="F.A.7">F.A.7</option>
                                    <option value="F.A.8">F.A.8</option>
                                </optgroup>
                                <optgroup label="Summative Assessments | 總結性評量">
                                    <option value="S.A.1">S.A.1</option>
                                    <option value="S.A.2">S.A.2</option>
                                    <option value="S.A.3">S.A.3</option>
                                    <option value="S.A.4">S.A.4</option>
                                </optgroup>
                                <optgroup label="Other Assessments | 其他評量">
                                    <option value="Midterm">Midterm | 期中考</option>
                                </optgroup>
                            </select>
                        </div>
                        
                        <div class="form-section">
                            <label for="newTitle"><i class="fas fa-edit"></i> New Title | 新標題:</label>
                            <input type="text" id="newTitle" class="form-control" placeholder="Enter new assessment title | 輸入新的評量標題">
                        </div>
                        
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="updateAssessmentTitle()">
                                <i class="fas fa-save"></i> Update Title | 更新標題
                            </button>
                            <button class="btn btn-secondary" onclick="closeAssessmentModal()">
                                <i class="fas fa-times"></i> Cancel | 取消
                            </button>
                        </div>
                        
                        <div id="assessment-result" class="result-section" style="display: none;">
                            <!-- Results will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Audit Modal -->
    <div id="progressAuditModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-check"></i> Progress Audit Configuration | 進度稽核設定</h2>
                <span class="close" onclick="closeProgressAuditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="progress-audit-content">
                    <div class="progress-audit-form">
                        <!-- Checkpoint Info -->
                        <div class="form-section">
                            <label for="checkpointName"><i class="fas fa-bookmark"></i> Checkpoint Name | 檢查點名稱:</label>
                            <input type="text" id="checkpointName" class="form-control" 
                                   placeholder="e.g., Mid-Term Progress Check | 期中進度檢查">
                        </div>
                        
                        <!-- Grade Level Tabs -->
                        <div class="tab-container">
                            <div class="tab-buttons">
                                <button class="tab-btn active" onclick="switchProgressTab('G1')">G1</button>
                                <button class="tab-btn" onclick="switchProgressTab('G2')">G2</button>
                                <button class="tab-btn" onclick="switchProgressTab('G3')">G3</button>
                                <button class="tab-btn" onclick="switchProgressTab('G4')">G4</button>
                                <button class="tab-btn" onclick="switchProgressTab('G5')">G5</button>
                                <button class="tab-btn" onclick="switchProgressTab('G6')">G6</button>
                            </div>
                            
                            <!-- Grade Level Content -->
                            <div id="G1-tab" class="tab-content active">
                                <div class="level-groups">
                                    <div class="level-group">
                                        <h4>G1E1</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G1E1-1" name="G1E1-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G1E1-2" name="G1E1-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G1E1-3" name="G1E1-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G1E1-4" name="G1E1-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G1E1-5" name="G1E1-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G1E1-6" name="G1E1-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G1E1-7" name="G1E1-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G1E1-8" name="G1E1-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G1E1-1" name="G1E1-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G1E1-2" name="G1E1-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G1E1-3" name="G1E1-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G1E1-4" name="G1E1-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="level-group">
                                        <h4>G1E2</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G1E2-1" name="G1E2-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G1E2-2" name="G1E2-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G1E2-3" name="G1E2-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G1E2-4" name="G1E2-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G1E2-5" name="G1E2-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G1E2-6" name="G1E2-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G1E2-7" name="G1E2-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G1E2-8" name="G1E2-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G1E2-1" name="G1E2-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G1E2-2" name="G1E2-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G1E2-3" name="G1E2-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G1E2-4" name="G1E2-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="level-group">
                                        <h4>G1E3</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G1E3-1" name="G1E3-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G1E3-2" name="G1E3-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G1E3-3" name="G1E3-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G1E3-4" name="G1E3-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G1E3-5" name="G1E3-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G1E3-6" name="G1E3-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G1E3-7" name="G1E3-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G1E3-8" name="G1E3-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G1E3-1" name="G1E3-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G1E3-2" name="G1E3-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G1E3-3" name="G1E3-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G1E3-4" name="G1E3-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- G2-G6 Tab Content (Full Implementation) -->
                            <!-- Due to length constraints, implementing simplified version for now -->
                            <!-- Each grade follows the same pattern as G1 with G2E1-G2E3, G3E1-G3E3, etc. -->
                            <div id="G2-tab" class="tab-content" style="display:none;">
                                <div class="level-groups">
                                    <div class="level-group">
                                        <h4>G2E1</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G2E1-1" name="G2E1-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G2E1-2" name="G2E1-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G2E1-3" name="G2E1-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G2E1-4" name="G2E1-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G2E1-5" name="G2E1-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G2E1-6" name="G2E1-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G2E1-7" name="G2E1-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G2E1-8" name="G2E1-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G2E1-1" name="G2E1-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G2E1-2" name="G2E1-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G2E1-3" name="G2E1-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G2E1-4" name="G2E1-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="level-group">
                                        <h4>G2E2</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G2E2-1" name="G2E2-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G2E2-2" name="G2E2-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G2E2-3" name="G2E2-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G2E2-4" name="G2E2-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G2E2-5" name="G2E2-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G2E2-6" name="G2E2-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G2E2-7" name="G2E2-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G2E2-8" name="G2E2-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G2E2-1" name="G2E2-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G2E2-2" name="G2E2-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G2E2-3" name="G2E2-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G2E2-4" name="G2E2-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="level-group">
                                        <h4>G2E3</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G2E3-1" name="G2E3-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G2E3-2" name="G2E3-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G2E3-3" name="G2E3-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G2E3-4" name="G2E3-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G2E3-5" name="G2E3-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G2E3-6" name="G2E3-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G2E3-7" name="G2E3-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G2E3-8" name="G2E3-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G2E3-1" name="G2E3-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G2E3-2" name="G2E3-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G2E3-3" name="G2E3-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G2E3-4" name="G2E3-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="G3-tab" class="tab-content" style="display:none;">
                                <div class="level-groups">
                                    <div class="level-group">
                                        <h4>G3E1</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G3E1-1" name="G3E1-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G3E1-2" name="G3E1-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G3E1-3" name="G3E1-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G3E1-4" name="G3E1-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G3E1-5" name="G3E1-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G3E1-6" name="G3E1-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G3E1-7" name="G3E1-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G3E1-8" name="G3E1-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G3E1-1" name="G3E1-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G3E1-2" name="G3E1-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G3E1-3" name="G3E1-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G3E1-4" name="G3E1-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="level-group">
                                        <h4>G3E2</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G3E2-1" name="G3E2-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G3E2-2" name="G3E2-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G3E2-3" name="G3E2-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G3E2-4" name="G3E2-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G3E2-5" name="G3E2-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G3E2-6" name="G3E2-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G3E2-7" name="G3E2-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G3E2-8" name="G3E2-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G3E2-1" name="G3E2-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G3E2-2" name="G3E2-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G3E2-3" name="G3E2-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G3E2-4" name="G3E2-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="level-group">
                                        <h4>G3E3</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G3E3-1" name="G3E3-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G3E3-2" name="G3E3-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G3E3-3" name="G3E3-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G3E3-4" name="G3E3-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G3E3-5" name="G3E3-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G3E3-6" name="G3E3-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G3E3-7" name="G3E3-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G3E3-8" name="G3E3-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G3E3-1" name="G3E3-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G3E3-2" name="G3E3-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G3E3-3" name="G3E3-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G3E3-4" name="G3E3-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="G4-tab" class="tab-content" style="display:none;">
                                <div class="level-groups">
                                    <!-- G4E1 Level Group -->
                                    <div class="level-group">
                                        <h4>G4E1</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G4E1-1" name="G4E1-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G4E1-2" name="G4E1-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G4E1-3" name="G4E1-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G4E1-4" name="G4E1-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G4E1-5" name="G4E1-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G4E1-6" name="G4E1-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G4E1-7" name="G4E1-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G4E1-8" name="G4E1-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G4E1-1" name="G4E1-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G4E1-2" name="G4E1-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G4E1-3" name="G4E1-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G4E1-4" name="G4E1-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- G4E2 Level Group -->
                                    <div class="level-group">
                                        <h4>G4E2</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G4E2-1" name="G4E2-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G4E2-2" name="G4E2-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G4E2-3" name="G4E2-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G4E2-4" name="G4E2-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G4E2-5" name="G4E2-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G4E2-6" name="G4E2-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G4E2-7" name="G4E2-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G4E2-8" name="G4E2-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G4E2-1" name="G4E2-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G4E2-2" name="G4E2-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G4E2-3" name="G4E2-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G4E2-4" name="G4E2-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- G4E3 Level Group -->
                                    <div class="level-group">
                                        <h4>G4E3</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G4E3-1" name="G4E3-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G4E3-2" name="G4E3-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G4E3-3" name="G4E3-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G4E3-4" name="G4E3-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G4E3-5" name="G4E3-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G4E3-6" name="G4E3-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G4E3-7" name="G4E3-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G4E3-8" name="G4E3-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G4E3-1" name="G4E3-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G4E3-2" name="G4E3-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G4E3-3" name="G4E3-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G4E3-4" name="G4E3-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="G5-tab" class="tab-content" style="display:none;">
                                <div class="level-groups">
                                    <!-- G5E1 Level Group -->
                                    <div class="level-group">
                                        <h4>G5E1</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G5E1-1" name="G5E1-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G5E1-2" name="G5E1-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G5E1-3" name="G5E1-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G5E1-4" name="G5E1-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G5E1-5" name="G5E1-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G5E1-6" name="G5E1-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G5E1-7" name="G5E1-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G5E1-8" name="G5E1-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G5E1-1" name="G5E1-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G5E1-2" name="G5E1-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G5E1-3" name="G5E1-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G5E1-4" name="G5E1-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- G5E2 Level Group -->
                                    <div class="level-group">
                                        <h4>G5E2</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G5E2-1" name="G5E2-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G5E2-2" name="G5E2-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G5E2-3" name="G5E2-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G5E2-4" name="G5E2-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G5E2-5" name="G5E2-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G5E2-6" name="G5E2-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G5E2-7" name="G5E2-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G5E2-8" name="G5E2-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G5E2-1" name="G5E2-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G5E2-2" name="G5E2-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G5E2-3" name="G5E2-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G5E2-4" name="G5E2-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- G5E3 Level Group -->
                                    <div class="level-group">
                                        <h4>G5E3</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G5E3-1" name="G5E3-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G5E3-2" name="G5E3-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G5E3-3" name="G5E3-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G5E3-4" name="G5E3-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G5E3-5" name="G5E3-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G5E3-6" name="G5E3-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G5E3-7" name="G5E3-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G5E3-8" name="G5E3-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G5E3-1" name="G5E3-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G5E3-2" name="G5E3-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G5E3-3" name="G5E3-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G5E3-4" name="G5E3-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="G6-tab" class="tab-content" style="display:none;">
                                <div class="level-groups">
                                    <!-- G6E1 Level Group -->
                                    <div class="level-group">
                                        <h4>G6E1</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G6E1-1" name="G6E1-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G6E1-2" name="G6E1-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G6E1-3" name="G6E1-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G6E1-4" name="G6E1-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G6E1-5" name="G6E1-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G6E1-6" name="G6E1-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G6E1-7" name="G6E1-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G6E1-8" name="G6E1-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G6E1-1" name="G6E1-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G6E1-2" name="G6E1-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G6E1-3" name="G6E1-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G6E1-4" name="G6E1-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- G6E2 Level Group -->
                                    <div class="level-group">
                                        <h4>G6E2</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G6E2-1" name="G6E2-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G6E2-2" name="G6E2-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G6E2-3" name="G6E2-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G6E2-4" name="G6E2-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G6E2-5" name="G6E2-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G6E2-6" name="G6E2-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G6E2-7" name="G6E2-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G6E2-8" name="G6E2-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G6E2-1" name="G6E2-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G6E2-2" name="G6E2-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G6E2-3" name="G6E2-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G6E2-4" name="G6E2-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- G6E3 Level Group -->
                                    <div class="level-group">
                                        <h4>G6E3</h4>
                                        <div class="assessment-selection">
                                            <div class="assessment-type">
                                                <strong>Formative (F.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="fa-G6E3-1" name="G6E3-FA" value="F.A.1" class="progress-checkbox"> F.A.1</label>
                                                    <label><input type="checkbox" id="fa-G6E3-2" name="G6E3-FA" value="F.A.2" class="progress-checkbox"> F.A.2</label>
                                                    <label><input type="checkbox" id="fa-G6E3-3" name="G6E3-FA" value="F.A.3" class="progress-checkbox"> F.A.3</label>
                                                    <label><input type="checkbox" id="fa-G6E3-4" name="G6E3-FA" value="F.A.4" class="progress-checkbox"> F.A.4</label>
                                                    <label><input type="checkbox" id="fa-G6E3-5" name="G6E3-FA" value="F.A.5" class="progress-checkbox"> F.A.5</label>
                                                    <label><input type="checkbox" id="fa-G6E3-6" name="G6E3-FA" value="F.A.6" class="progress-checkbox"> F.A.6</label>
                                                    <label><input type="checkbox" id="fa-G6E3-7" name="G6E3-FA" value="F.A.7" class="progress-checkbox"> F.A.7</label>
                                                    <label><input type="checkbox" id="fa-G6E3-8" name="G6E3-FA" value="F.A.8" class="progress-checkbox"> F.A.8</label>
                                                </div>
                                            </div>
                                            <div class="assessment-type">
                                                <strong>Summative (S.A.):</strong>
                                                <div class="checkbox-group">
                                                    <label><input type="checkbox" id="sa-G6E3-1" name="G6E3-SA" value="S.A.1" class="progress-checkbox"> S.A.1</label>
                                                    <label><input type="checkbox" id="sa-G6E3-2" name="G6E3-SA" value="S.A.2" class="progress-checkbox"> S.A.2</label>
                                                    <label><input type="checkbox" id="sa-G6E3-3" name="G6E3-SA" value="S.A.3" class="progress-checkbox"> S.A.3</label>
                                                    <label><input type="checkbox" id="sa-G6E3-4" name="G6E3-SA" value="S.A.4" class="progress-checkbox"> S.A.4</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="runProgressAudit()">
                                <i class="fas fa-play"></i> Run Audit | 執行稽核
                            </button>
                            <button class="btn btn-secondary" onclick="closeProgressAuditModal()">
                                <i class="fas fa-times"></i> Cancel | 取消
                            </button>
                        </div>
                        
                        <!-- Loading Indicator -->
                        <div id="progress-audit-loading" class="loading-indicator" style="display: none;">
                            <div class="loading-content">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Analyzing progress... | 正在分析進度...</span>
                            </div>
                        </div>
                        
                        <!-- Message Display -->
                        <div id="progress-audit-message" class="progress-audit-message" style="display: none;"></div>
                        
                        <!-- Results Display -->
                        <div id="progress-audit-results" class="progress-results" style="display: none;">
                            <!-- Audit results will be displayed here -->
                        </div>
                        
                        <!-- Legacy result div for compatibility -->
                        <div id="progress-audit-result" class="result-section" style="display: none;">
                            <!-- Backup results display -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Error handling for debugging
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error occurred: ', {
                message: msg,
                source: url,
                lineno: lineNo,
                colno: columnNo,
                error: error
            });
            return false;
        };
        
        // Debug info
        console.log('Dashboard script loading...');
        
        // Global variables
        let isLoading = false;

        // Test backend connection
        function testBackendConnection() {
            console.log('🔍 Testing backend connection...');
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('✅ Backend connection successful:', result);
                    })
                    .withFailureHandler(function(error) {
                        console.error('❌ Backend connection failed:', error);
                        showError('後端連接失敗：' + error.message);
                    })
                    .getSystemVersion(); // Simple test function
            } catch (error) {
                console.error('❌ Google.script.run not available:', error);
                showError('Google Apps Script 連接不可用');
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing dashboard...');
            
            // Ensure critical functions are available globally
            if (typeof openProgressAudit === 'function') {
                window.openProgressAudit = openProgressAudit;
            }
            if (typeof openAssessmentTitleManager === 'function') {
                window.openAssessmentTitleManager = openAssessmentTitleManager;
            }
            
            // Log function availability for debugging
            console.log('Critical functions check:', {
                openProgressAudit: typeof window.openProgressAudit,
                openAssessmentTitleManager: typeof window.openAssessmentTitleManager
            });
            
            // Test backend connection
            setTimeout(testBackendConnection, 1000);
            
            updateTimestamp();
            loadSystemStatistics();
            setInterval(updateTimestamp, 60000); // Update every minute
        });

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-updated').textContent = now.toLocaleString();
        }

        // Show loading indicator
        function showLoading() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('loading').style.display = 'block';
            hideAlerts();
        }

        // Hide loading indicator
        function hideLoading() {
            isLoading = false;
            document.getElementById('loading').style.display = 'none';
        }

        // Show success message
        function showSuccess(message) {
            const alert = document.getElementById('alert-success');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // Show error message
        function showError(message) {
            const alert = document.getElementById('alert-error');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // Hide all alerts
        function hideAlerts() {
            document.getElementById('alert-success').style.display = 'none';
            document.getElementById('alert-error').style.display = 'none';
        }

        // System Functions
        function initializeSystem() {
            console.log('🔘 initializeSystem button clicked');
            showLoading();
            
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('✅ initializeSystem success:', result);
                        hideLoading();
                        showSuccess('✅ System initialized successfully! | 系統初始化成功！');
                        loadSystemStatistics();
                    })
                    .withFailureHandler(function(error) {
                        console.error('❌ initializeSystem failed:', error);
                        hideLoading();
                        showError('❌ Initialization failed: ' + error.message + ' | 初始化失敗');
                    })
                    .initializeSystem();
            } catch (error) {
                console.error('❌ initializeSystem call error:', error);
                hideLoading();
                showError('呼叫初始化函數時發生錯誤：' + error.message);
            }
        }

        function checkSystemStatus() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('🟢 System Status: Healthy | 系統狀態健康');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Status check failed: ' + error.message + ' | 狀態檢查失敗');
                })
                .getSystemStatistics();
        }

        function refreshDashboard() {
            showLoading();
            loadSystemStatistics();
            setTimeout(() => {
                hideLoading();
                showSuccess('✅ Dashboard refreshed successfully!');
            }, 1000);
        }

        function openHTDashboard() {
            // FIXED: Always use the correct deployment URL
            const htUrl = 'https://script.google.com/macros/s/AKfycbwQD6FGVvt3R4_L5RGS8BB7yapJlE8S9gd4E8HyJRI/exec?page=ht';
            
            console.log('Opening HT Dashboard:', htUrl);
            window.open(htUrl, '_blank');
        }

        function loadSystemStatistics() {
            google.script.run
                .withSuccessHandler(function(stats) {
                    document.getElementById('total-teachers').textContent = stats.totalTeachers || 0;
                    document.getElementById('total-students').textContent = stats.totalStudents || 0;
                    document.getElementById('active-gradebooks').textContent = stats.activeGradebooks || 0;
                    document.getElementById('system-files').textContent = stats.systemFiles || 0;
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load statistics:', error);
                })
                .getSystemStatistics();
        }

        function openSystemFolder() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        window.open(result.url, '_blank');
                        showSuccess('📁 Opening system folder');
                    } else {
                        showError('❌ Cannot open system folder: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    showError('❌ Cannot open system folder: ' + error.message);
                })
                .getSystemFolderUrl();
        }

        function openMasterData() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        window.open(result.url, '_blank');
                        showSuccess('📋 Opening master data sheet: ' + result.name);
                    } else {
                        let errorMessage = '❌ Cannot open master data: ' + result.error;
                        if (result.step) {
                            errorMessage += '\n\nFailed at step: ' + result.step;
                        }
                        if (result.filesInFolder) {
                            errorMessage += '\n\nFiles found: ' + result.filesInFolder.join(', ');
                        }
                        showError(errorMessage);
                    }
                })
                .withFailureHandler(function(error) {
                    showError('❌ Cannot open master data: ' + error.message);
                })
                .getMasterDataUrl();
        }


        // Batch create gradebooks functionality
        function batchCreateGradebooks() {
            console.log('🔘 batchCreateGradebooks button clicked');
            
            if (!confirm('This will create gradebooks for all teachers. This process may take several minutes. Continue?')) {
                console.log('User cancelled batch creation');
                return;
            }
            
            showLoading();
            console.log('📤 Calling backend batchCreateGradebooks...');
            
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('✅ batchCreateGradebooks success:', result);
                        hideLoading();
                        if (result && result.success) {
                            let message = `🎉 Gradebook creation completed!\n\n`;
                            message += `✅ Successfully created: ${result.successCount} gradebooks\n`;
                            if (result.errorCount > 0) {
                                message += `❌ Errors: ${result.errorCount} gradebooks\n`;
                            }
                            message += `⏱️ Total time: ${result.duration} seconds\n`;
                            message += `👥 Total teachers: ${result.totalTeachers}`;
                            
                            if (result.errors && result.errors.length > 0) {
                            message += `\n\n⚠️ Errors encountered:\n${result.errors.slice(0, 5).join('\n')}`;
                            if (result.errors.length > 5) {
                                message += `\n... and ${result.errors.length - 5} more errors`;
                            }
                        }
                        
                        showSuccess(message);
                        loadSystemStatistics();
                    } else {
                        showError('❌ Gradebook creation failed: ' + (result.message || result.error || 'Unknown error'));
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('❌ batchCreateGradebooks failed:', error);
                    hideLoading();
                    showError('❌ Failed to create gradebooks: ' + error.message);
                })
                .batchCreateGradebooks();
            } catch (error) {
                console.error('❌ batchCreateGradebooks call error:', error);
                hideLoading();
                showError('呼叫批量建立函數時發生錯誤：' + error.message);
            }
        }

        // Progress Check Functions | 進度檢查函數
        function quickProgressCheck() {
            if (!confirm('This will check progress for all teachers with default standards (3 F.A. + 1 S.A.). Continue?\n\n這將使用預設標準（3次平時評量 + 1次總結評量）檢查所有教師進度。繼續？')) {
                return;
            }
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        displayProgressCheckResults(result.summary);
                        showSuccess(`✅ Progress check completed in ${result.duration}s\n📊 Checked ${result.summary.totalClasses} classes from ${result.summary.totalTeachers} teachers`);
                        if (result.reportUrl) {
                            setTimeout(() => {
                                if (confirm('View detailed progress report?\n查看詳細進度報告？')) {
                                    window.open(result.reportUrl, '_blank');
                                }
                            }, 2000);
                        }
                    } else {
                        showError('❌ Progress check failed: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Progress check failed: ' + error.message);
                })
                .batchCheckAllProgress();
        }

        function openProgressStandardsDialog() {
            const html = `
                <div style="padding: 20px; font-family: Arial, sans-serif; max-width: 500px;">
                    <h2 style="color: #4285F4; margin-bottom: 20px;">
                        <i class="fas fa-cogs"></i> Set Progress Check Standards | 設定進度檢查標準
                    </h2>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">Check Description | 檢查描述:</label><br>
                        <input type="text" id="checkDescription" value="Progress Check - Week 8" 
                               style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">Required Formative Assessments | 需完成平時評量:</label><br>
                        <select id="formativeRequired" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0">0 - No F.A. required</option>
                            <option value="1">1 - F.A.1</option>
                            <option value="2">2 - F.A.1, F.A.2</option>
                            <option value="3" selected>3 - F.A.1, F.A.2, F.A.3</option>
                            <option value="4">4 - F.A.1 to F.A.4</option>
                            <option value="5">5 - F.A.1 to F.A.5</option>
                            <option value="6">6 - F.A.1 to F.A.6</option>
                            <option value="7">7 - F.A.1 to F.A.7</option>
                            <option value="8">8 - All F.A. (F.A.1 to F.A.8)</option>
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-weight: bold;">Required Summative Assessments | 需完成總結評量:</label><br>
                        <select id="summativeRequired" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0">0 - No S.A. required</option>
                            <option value="1" selected>1 - S.A.1</option>
                            <option value="2">2 - S.A.1, S.A.2</option>
                            <option value="3">3 - S.A.1, S.A.2, S.A.3</option>
                            <option value="4">4 - All S.A. (S.A.1 to S.A.4)</option>
                        </select>
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                        <h4 style="margin: 0 0 10px 0; color: #1976d2;">Progress Standards | 進度標準:</h4>
                        <ul style="margin: 5px 0; padding-left: 20px; color: #555;">
                            <li>🟢 Excellent (≥90%): 進度優秀</li>
                            <li>🟡 Good (80-89%): 進度良好</li>
                            <li>🟠 Normal (60-79%): 進度正常</li>
                            <li>🔴 Behind (<60%): 進度落後</li>
                        </ul>
                        <p style="font-size: 0.9em; color: #666; margin: 10px 0 0 0;">
                            System will check: Empty cells and 0 scores = incomplete, "N" and scores >0 = complete
                        </p>
                    </div>
                    
                    <div style="margin: 20px 0; text-align: center;">
                        <button onclick="executeCustomProgressCheck()" 
                                style="background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 5px; margin-right: 10px; cursor: pointer; font-size: 16px;">
                            🚀 Start Custom Check | 開始自訂檢查
                        </button>
                        <button onclick="closeProgressDialog()" 
                                style="background: #999; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                            Cancel | 取消
                        </button>
                    </div>
                </div>
            `;
            
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'progressModal';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                justify-content: center; align-items: center;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white; border-radius: 10px; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
                max-width: 90%; max-height: 90%; overflow-y: auto;
            `;
            modal.innerHTML = html;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Add global functions for modal
            window.executeCustomProgressCheck = function() {
                const description = document.getElementById('checkDescription').value;
                const formativeRequired = parseInt(document.getElementById('formativeRequired').value);
                const summativeRequired = parseInt(document.getElementById('summativeRequired').value);
                
                const standards = {
                    formativeRequired: formativeRequired,
                    summativeRequired: summativeRequired,
                    finalRequired: 0,
                    description: description,
                    checkDate: new Date()
                };
                
                closeProgressDialog();
                
                showLoading();
                google.script.run
                    .withSuccessHandler(function(result) {
                        hideLoading();
                        if (result.success) {
                            displayProgressCheckResults(result.summary);
                            showSuccess(`✅ Custom progress check completed in ${result.duration}s\n📊 Standard: ${formativeRequired} F.A. + ${summativeRequired} S.A.`);
                            if (result.reportUrl) {
                                setTimeout(() => {
                                    if (confirm('View detailed progress report?\n查看詳細進度報告？')) {
                                        window.open(result.reportUrl, '_blank');
                                    }
                                }, 2000);
                            }
                        } else {
                            showError('❌ Custom progress check failed: ' + result.error);
                        }
                    })
                    .withFailureHandler(function(error) {
                        hideLoading();
                        showError('❌ Custom progress check failed: ' + error.message);
                    })
                    .batchCheckAllProgress(standards);
            };
            
            window.closeProgressDialog = function() {
                const modal = document.getElementById('progressModal');
                if (modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        function displayProgressCheckResults(summary) {
            const resultHtml = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 10px 0;">
                    <h3 style="color: #4285F4; margin: 0 0 15px 0;">
                        📊 Progress Check Results | 進度檢查結果
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #4285F4;">${summary.totalTeachers}</div>
                            <div>Teachers Checked<br>已檢查教師</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #4285F4;">${summary.totalClasses}</div>
                            <div>Total Classes<br>班級總數</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #4CAF50;">${summary.classesOnTrack}</div>
                            <div>Classes On Track<br>進度正常</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #f44336;">${summary.classesBehind}</div>
                            <div>Classes Behind<br>進度落後</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #FF9800;">${summary.systemProgress.toFixed(1)}%</div>
                            <div>System Progress<br>系統進度</div>
                        </div>
                    </div>
                    ${summary.classesBehind > 0 ? `
                        <div style="background: #ffebee; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 4px solid #f44336;">
                            <strong style="color: #d32f2f;">⚠️ Alert: ${summary.classesBehind} classes are behind schedule</strong>
                            <br><small>Check the detailed report for specific recommendations</small>
                        </div>
                    ` : `
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-top: 15px; border-left: 4px solid #4CAF50;">
                            <strong style="color: #2e7d32;">✅ Excellent: All classes are on track!</strong>
                        </div>
                    `}
                </div>
            `;
            
            // Display in alert area or create temporary display
            const alertDiv = document.createElement('div');
            alertDiv.innerHTML = resultHtml;
            alertDiv.style.cssText = 'position: fixed; top: 20%; left: 50%; transform: translateX(-50%); z-index: 999; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 90%; max-height: 70%; overflow-y: auto;';
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '✕';
            closeBtn.style.cssText = 'position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 18px; cursor: pointer; color: #999;';
            closeBtn.onclick = () => document.body.removeChild(alertDiv);
            
            alertDiv.appendChild(closeBtn);
            document.body.appendChild(alertDiv);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    document.body.removeChild(alertDiv);
                }
            }, 10000);
        }

        function generateReport() {
            showSuccess('📋 Report generation feature coming soon!');
        }

        function importStudentData() {
            showSuccess('📥 Import feature coming soon!');
        }

        function exportStudentData() {
            showSuccess('📤 Export feature coming soon!');
        }

        function systemBackup() {
            showSuccess('🔄 Backup feature coming soon!');
        }

        function testSystemIntegrity() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        showSuccess(`✅ System Test Passed!\n\n${result.summary}\n\nAll critical functions are working properly.`);
                    } else {
                        let message = `❌ System Test Issues Found:\n\n${result.summary}`;
                        if (result.errors && result.errors.length > 0) {
                            message += `\n\nErrors:\n${result.errors.join('\n')}`;
                        }
                        showError(message);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ System test failed: ' + error.message);
                })
                .testSystemIntegrity();
        }

        function performQualityCheck() {
            if (!confirm('This will perform a comprehensive code quality and security analysis. This may take 1-2 minutes. Continue?\n\n這將執行全面的代碼品質和安全分析，可能需要1-2分鐘。繼續？')) {
                return;
            }
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        let message = `📊 Code Quality Analysis Complete!\n\n${result.summary}\n\n${result.report}`;
                        if (result.recommendations && result.recommendations.length > 0) {
                            const recommendationList = result.recommendations.map(r => '• ' + r).join('\n');
                            message += `\n\n🎯 Recommendations:\n${recommendationList}`;
                        }
                        showSuccess(message);
                    } else {
                        showError('❌ Quality check failed: ' + (result.error || 'Unknown error'));
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Quality check failed: ' + error.message);
                })
                .performCodeQualityCheck();
        }

        function openResourceManager() {
            const resourceTypes = ['template', 'function', 'integration', 'documentation', 'tool', 'component'];
            const typeDescriptions = {
                'template': 'Spreadsheet templates for reports, assessments, etc.',
                'function': 'Utility functions and code libraries',
                'integration': 'Third-party service integrations',
                'documentation': 'User guides and technical documentation',
                'tool': 'System utilities and helper tools',
                'component': 'UI components and interface elements'
            };
            
            let optionsHtml = resourceTypes.map(type => 
                `<option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)} - ${typeDescriptions[type]}</option>`
            ).join('');
            
            const html = `
                <div style="padding: 20px; font-family: Arial, sans-serif; max-width: 500px;">
                    <h2>🔧 Add New Project Resource | 添加新專案資源</h2>
                    
                    <div style="margin: 15px 0;">
                        <label><strong>Resource Type | 資源類型:</strong></label><br>
                        <select id="resourceType" style="width: 100%; padding: 8px; margin-top: 5px;">
                            ${optionsHtml}
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label><strong>Resource Name | 資源名稱:</strong></label><br>
                        <input type="text" id="resourceName" placeholder="e.g., Grade Report Template" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label><strong>Description | 描述:</strong></label><br>
                        <textarea id="resourceDescription" rows="3" 
                                  placeholder="Brief description of what this resource does..."
                                  style="width: 100%; padding: 8px; margin-top: 5px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin: 20px 0; display: flex; gap: 10px;">
                        <button onclick="createNewResource()" 
                                style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; flex: 1;">
                            🚀 Create Resource | 創建資源
                        </button>
                        <button onclick="listExistingResources()" 
                                style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; flex: 1;">
                            📋 List Resources | 列出資源
                        </button>
                    </div>
                    
                    <div id="resourceResult" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
                    </div>
                </div>
            `;
            
            showModal('Resource Manager | 資源管理器', html);
        }

        function createNewResource() {
            const type = document.getElementById('resourceType').value;
            const name = document.getElementById('resourceName').value;
            const description = document.getElementById('resourceDescription').value;
            
            if (!name.trim()) {
                alert('Please enter a resource name | 請輸入資源名稱');
                return;
            }
            
            if (!description.trim()) {
                alert('Please enter a description | 請輸入描述');
                return;
            }
            
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        const resultDiv = document.getElementById('resourceResult');
                        resultDiv.style.display = 'block';
                        let html = `
                            <h4>✅ Resource Created Successfully! | 資源創建成功！</h4>
                            <p><strong>Resource ID:</strong> ${result.resourceId}</p>
                            <p><strong>Type:</strong> ${result.details.type}</p>
                            <p><strong>Message:</strong> ${result.message}</p>
                        `;
                        
                        if (result.details.templateUrl) {
                            html += '<p><a href="' + result.details.templateUrl + '" target="_blank">📄 Open Template</a></p>';
                        }
                        if (result.details.docUrl) {
                            html += '<p><a href="' + result.details.docUrl + '" target="_blank">📖 Open Documentation</a></p>';
                        }
                        if (result.details.configUrl) {
                            html += '<p><a href="' + result.details.configUrl + '" target="_blank">⚙️ Open Configuration</a></p>';
                        }
                        
                        resultDiv.innerHTML = html;
                        
                        // Clear form
                        document.getElementById('resourceName').value = '';
                        document.getElementById('resourceDescription').value = '';
                        
                        showSuccess(`🎉 Resource "${name}" created successfully!\n\nResource ID: ${result.resourceId}`);
                    } else {
                        showError('❌ Failed to create resource: ' + (result.error || 'Unknown error'));
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Failed to create resource: ' + error.message);
                })
                .addNewResource(type, name, description, {});
        }

        function listExistingResources() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        const resultDiv = document.getElementById('resourceResult');
                        resultDiv.style.display = 'block';
                        
                        let html = `<h4>📋 Existing Resources (${result.total}) | 現有資源</h4>`;
                        if (result.resources.length === 0) {
                            html += '<p>No resources found | 未找到資源</p>';
                        } else {
                            html += '<div style="max-height: 200px; overflow-y: auto;">';
                            result.resources.forEach(resource => {
                                html += `
                                    <div style="border: 1px solid #ddd; margin: 5px 0; padding: 10px; border-radius: 3px;">
                                        <strong>${resource.name}</strong> (${resource.type})
                                        <br><small>${resource.description}</small>
                                        <br><small>Created: ${new Date(resource.created).toLocaleDateString()}</small>
                                    </div>
                                `;
                            });
                            html += '</div>';
                        }
                        
                        resultDiv.innerHTML = html;
                    } else {
                        showError('❌ Failed to list resources: ' + (result.error || 'Unknown error'));
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Failed to list resources: ' + error.message);
                })
                .listProjectResources();
        }

        function showModal(title, content) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white; border-radius: 10px; max-width: 600px;
                max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            modal.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee;">
                    <h3 style="margin: 0;">${title}</h3>
                    <button onclick="this.closest('.modal-overlay').remove()" 
                            style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div>${content}</div>
            `;
            
            overlay.className = 'modal-overlay';
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        function updateTeachers() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('✅ Teachers updated successfully! Found ' + result.length + ' teachers');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Failed to update teachers: ' + error.message);
                })
                .updateAutoGeneratedTeachers();
        }

        function updateStudentStatus() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('✅ Student status updated successfully!');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Failed to update student status: ' + error.message);
                })
                .updateStudentStatus();
        }

        function debugSystem() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    let studentSamplesText = '';
                    if (result.studentSamples && result.studentSamples.length > 0) {
                        studentSamplesText = result.studentSamples.map(s => 
                            `• ${s.name || 'empty'} (Status: ${s.status || 'empty'}, Class: ${s.englishClass || 'empty'}, LT: ${s.ltTeacher || 'empty'}, IT: ${s.itTeacher || 'empty'})`
                        ).join('\n');
                    }
                    
                    let teacherSamplesText = '';
                    if (result.teacherSamples && result.teacherSamples.length > 0) {
                        teacherSamplesText = result.teacherSamples.map(t => 
                            `• ${t.name} (${t.subject}) - Classes: ${t.classes}`
                        ).join('\n');
                    }
                    
                    const debugInfo = `
🔍 System Debug Results:

📁 System Folder: ${result.systemFolder}
📋 Master Data Sheet: ${result.masterDataSheet}  
👥 Students Data: ${result.studentsData} total records
📝 Students with "在學" status: ${result.studentsWithStatus}
👨‍🏫 Teachers Found: ${result.teachersFound}
📊 Gradebooks Folder: ${result.teacherGradebooksFolder}

📄 Student Samples (first 5):
${studentSamplesText || 'No student data found'}

👩‍🏫 Teacher Samples:
${teacherSamplesText || 'No teacher data found'}

${result.error ? '❌ Error: ' + result.error : '✅ No errors detected'}
                    `;
                    showSuccess(debugInfo);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Debug failed: ' + error.message);
                })
                .debugSystemStatus();
        }

        function checkHeaders() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    let headersText = '';
                    if (result.headers) {
                        headersText = result.headers.map((header, index) => 
                            `${index + 1}. "${header}"`
                        ).join('\n');
                    }
                    
                    let indicesText = '';
                    if (result.columnIndices) {
                        indicesText = Object.entries(result.columnIndices).map(([col, index]) => 
                            `"${col}": ${index === -1 ? 'NOT FOUND' : 'Column ' + (index + 1)}`
                        ).join('\n');
                    }
                    
                    let sampleRowText = '';
                    if (result.sampleRow) {
                        sampleRowText = result.sampleRow.map((value, index) => 
                            `${index + 1}. ${value || 'empty'}`
                        ).join('\n');
                    }
                    
                    const headerInfo = `
📋 Column Headers Check:

📊 Total Columns: ${result.columnCount}
📄 Data Rows: ${result.dataRows}

🔍 All Headers:
${headersText}

🎯 Key Column Indices:
${indicesText}

📝 Sample Row Data:
${sampleRowText}

${result.error ? '❌ Error: ' + result.error : '✅ Headers checked successfully'}
                    `;
                    showSuccess(headerInfo);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Header check failed: ' + error.message);
                })
                .checkColumnHeaders();
        }

        function testCreation() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.error) {
                        showError('❌ Test failed: ' + result.error);
                        return;
                    }
                    
                    let assignmentText = '';
                    if (result && result.length > 0) {
                        assignmentText = result.map(assignment => 
                            `🏫 ${assignment.teacher} (${assignment.subject})
   📚 Class: ${assignment.class}
   👥 Students (${assignment.studentCount}): ${assignment.studentNames.join(', ')}`
                        ).join('\n\n');
                    }
                    
                    const testInfo = `
🧪 Gradebook Creation Test:

${assignmentText || 'No valid assignments found'}

${result.length === 0 ? '⚠️ No students were assigned to any teachers!' : '✅ Student assignments look correct!'}
                    `;
                    showSuccess(testInfo);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Test failed: ' + error.message);
                })
                .testGradebookCreation();
        }

        function validateClassAssignments() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.isValid) {
                        showSuccess(`✅ Class assignments validation passed!\n\nDefined classes: ${result.definedClasses.length}\nNo assignment conflicts found.`);
                    } else {
                        let message = `⚠️ Class assignment validation issues found:\n\n`;
                        message += `Issues (${result.issues.length}):\n`;
                        result.issues.slice(0, 10).forEach(issue => {
                            message += `• ${issue}\n`;
                        });
                        if (result.issues.length > 10) {
                            message += `• ... and ${result.issues.length - 10} more issues\n`;
                        }
                        message += `\nUndefined classes: ${result.undefinedClasses.join(', ')}\n`;
                        message += `\nPlease update Students sheet to match Classes sheet definitions.`;
                        showError(message);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Validation failed: ' + error.message);
                })
                .validateStudentClassAssignments();
        }

        function systemMaintenance() {
            showSuccess('🔧 Maintenance feature coming soon!');
        }

        // Assessment Title Management Functions
        function manageAssessmentTitles() {
            document.getElementById('assessmentModal').style.display = 'block';
            loadAssessmentTitles();
        }

        function closeAssessmentModal() {
            document.getElementById('assessmentModal').style.display = 'none';
        }

        function loadAssessmentTitles() {
            const content = document.getElementById('assessment-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>Loading level configurations...</p>
                </div>
            `;

            // Load assessment titles by levels instead of classes
            renderAssessmentLevels();
        }

        function renderAssessmentLevels() {
            const content = document.getElementById('assessment-content');
            
            // Define all available levels based on system configuration
            const levels = [
                // Grade 1 Levels
                { level: 'G1E1', grade: 'Grade 1' },
                { level: 'G1E2', grade: 'Grade 1' },
                { level: 'G1E3', grade: 'Grade 1' },
                
                // Grade 2 Levels
                { level: 'G2E1', grade: 'Grade 2' },
                { level: 'G2E2', grade: 'Grade 2' },
                { level: 'G2E3', grade: 'Grade 2' },
                
                // Grade 3 Levels
                { level: 'G3E1', grade: 'Grade 3' },
                { level: 'G3E2', grade: 'Grade 3' },
                { level: 'G3E3', grade: 'Grade 3' },
                
                // Grade 4 Levels
                { level: 'G4E1', grade: 'Grade 4' },
                { level: 'G4E2', grade: 'Grade 4' },
                { level: 'G4E3', grade: 'Grade 4' },
                
                // Grade 5 Levels
                { level: 'G5E1', grade: 'Grade 5' },
                { level: 'G5E2', grade: 'Grade 5' },
                { level: 'G5E3', grade: 'Grade 5' },
                
                // Grade 6 Levels
                { level: 'G6E1', grade: 'Grade 6' },
                { level: 'G6E2', grade: 'Grade 6' },
                { level: 'G6E3', grade: 'Grade 6' },
                { level: 'G6', grade: 'Grade 6' }
            ];

            let html = `
                <div style="margin-bottom: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px;">
                    <h3 style="margin: 0 0 10px 0; color: #1976d2;">
                        <i class="fas fa-info-circle"></i> Level-Based Assessment Title Management
                    </h3>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li>Manage assessment titles by educational levels (G1E1, G1E2, etc.)</li>
                        <li>Each level has separate sections for LT (Local Teacher) and IT (International Teacher)</li>
                        <li>Modify assessment titles below and click "Update" to save changes</li>
                        <li>Click "Reset" to restore default titles (F.A.1-F.A.8, S.A.1-S.A.4)</li>
                        <li>Changes will be synced to all existing gradebooks using this level</li>
                    </ul>
                </div>
            `;

            // Group by grade
            const groupedLevels = {};
            levels.forEach(levelConfig => {
                if (!groupedLevels[levelConfig.grade]) {
                    groupedLevels[levelConfig.grade] = [];
                }
                groupedLevels[levelConfig.grade].push(levelConfig);
            });

            // Render each grade
            Object.keys(groupedLevels).sort().forEach(grade => {
                html += `<h3 style="margin: 30px 0 20px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                    <i class="fas fa-graduation-cap"></i> ${grade} Levels
                </h3>`;

                groupedLevels[grade].forEach(levelConfig => {
                    html += createLevelCard(levelConfig);
                });
            });

            content.innerHTML = html;
        }

        function createLevelCard(levelConfig) {
            // Get default titles for both LT and IT
            const defaultTitles = {
                formative: ['F.A.1', 'F.A.2', 'F.A.3', 'F.A.4', 'F.A.5', 'F.A.6', 'F.A.7', 'F.A.8'],
                summative: ['S.A.1', 'S.A.2', 'S.A.3', 'S.A.4']
            };
            
            return `
                <div class="class-card">
                    <div class="class-header">
                        <div class="class-info">
                            <h3>${levelConfig.level}</h3>
                            <p><strong>Grade:</strong> ${levelConfig.grade}</p>
                        </div>
                    </div>
                    
                    <!-- LT Section -->
                    <div style="border: 2px solid #ff9800; border-radius: 10px; padding: 15px; margin-bottom: 20px; background: #fff3e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #f57c00;">
                                <i class="fas fa-user-tie" style="margin-right: 8px;"></i>
                                LT (Local Teacher)
                            </h4>
                            <div>
                                <button class="btn-update" onclick="updateLevelAssessmentTitles('${levelConfig.level}', 'LT')" style="margin-right: 5px;">
                                    <i class="fas fa-save"></i> Update LT
                                </button>
                                <button class="btn-reset" onclick="resetLevelAssessmentTitles('${levelConfig.level}', 'LT')">
                                    <i class="fas fa-undo"></i> Reset LT
                                </button>
                            </div>
                        </div>
                        
                        <div class="assessment-section">
                            <h5><i class="fas fa-pencil-alt" style="color: #2196f3;"></i> Formative Assessments (8 items)</h5>
                            <div class="assessment-grid">
                                ${defaultTitles.formative.map((title, index) => 
                                    `<input type="text" class="assessment-input" 
                                            id="formative-${levelConfig.level}-LT-${index}" 
                                            value="${title}" 
                                            placeholder="F.A.${index + 1}">`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div class="assessment-section">
                            <h5><i class="fas fa-chart-bar" style="color: #4caf50;"></i> Summative Assessments (4 items)</h5>
                            <div class="assessment-grid">
                                ${defaultTitles.summative.map((title, index) => 
                                    `<input type="text" class="assessment-input" 
                                            id="summative-${levelConfig.level}-LT-${index}" 
                                            value="${title}" 
                                            placeholder="S.A.${index + 1}">`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- IT Section -->
                    <div style="border: 2px solid #2196f3; border-radius: 10px; padding: 15px; background: #e3f2fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #1976d2;">
                                <i class="fas fa-globe" style="margin-right: 8px;"></i>
                                IT (International Teacher)
                            </h4>
                            <div>
                                <button class="btn-update" onclick="updateLevelAssessmentTitles('${levelConfig.level}', 'IT')" style="margin-right: 5px;">
                                    <i class="fas fa-save"></i> Update IT
                                </button>
                                <button class="btn-reset" onclick="resetLevelAssessmentTitles('${levelConfig.level}', 'IT')">
                                    <i class="fas fa-undo"></i> Reset IT
                                </button>
                            </div>
                        </div>
                        
                        <div class="assessment-section">
                            <h5><i class="fas fa-pencil-alt" style="color: #2196f3;"></i> Formative Assessments (8 items)</h5>
                            <div class="assessment-grid">
                                ${defaultTitles.formative.map((title, index) => 
                                    `<input type="text" class="assessment-input" 
                                            id="formative-${levelConfig.level}-IT-${index}" 
                                            value="${title}" 
                                            placeholder="F.A.${index + 1}">`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div class="assessment-section">
                            <h5><i class="fas fa-chart-bar" style="color: #4caf50;"></i> Summative Assessments (4 items)</h5>
                            <div class="assessment-grid">
                                ${defaultTitles.summative.map((title, index) => 
                                    `<input type="text" class="assessment-input" 
                                            id="summative-${levelConfig.level}-IT-${index}" 
                                            value="${title}" 
                                            placeholder="S.A.${index + 1}">`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        function updateLevelAssessmentTitles(level, teacherType) {
            // Collect formative titles
            const formativeTitles = [];
            for (let i = 0; i < 8; i++) {
                const input = document.getElementById(`formative-${level}-${teacherType}-${i}`);
                formativeTitles.push(input ? input.value.trim() : `F.A.${i + 1}`);
            }

            // Collect summative titles
            const summativeTitles = [];
            for (let i = 0; i < 4; i++) {
                const input = document.getElementById(`summative-${level}-${teacherType}-${i}`);
                summativeTitles.push(input ? input.value.trim() : `S.A.${i + 1}`);
            }

            // Validate inputs
            if (formativeTitles.some(title => !title) || summativeTitles.some(title => !title)) {
                showError('❌ All fields must be filled');
                return;
            }

            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        let message = `✅ ${result.message}`;
                        if (result.sheetsUpdated) {
                            message += `\n📊 Updated ${result.sheetsUpdated} gradebook sheets`;
                        }
                        if (result.warnings && result.warnings.length > 0) {
                            message += `\n⚠️ Some issues occurred during synchronization:\n${result.warnings.join('\n')}`;
                        }
                        showSuccess(message);
                    } else {
                        showError(`❌ Failed to update ${level}: ${result.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Update failed: ' + error.message);
                })
                .syncAssessmentTitlesByLevel(level, teacherType, formativeTitles, summativeTitles);
        }

        function resetLevelAssessmentTitles(level, teacherType) {
            if (!confirm(`Are you sure you want to reset assessment titles for ${level}? This will restore default titles and sync to all gradebooks using this level.`)) {
                return;
            }

            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        let message = `✅ ${result.message}`;
                        if (result.sheetsUpdated) {
                            message += `\n📊 Updated ${result.sheetsUpdated} gradebook sheets`;
                        }
                        if (result.warnings && result.warnings.length > 0) {
                            message += `\n⚠️ Some issues occurred during synchronization:\n${result.warnings.join('\n')}`;
                        }
                        showSuccess(message);
                        loadAssessmentTitles(); // Reload to show default titles
                    } else {
                        showError(`❌ Failed to reset ${level}: ${result.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Reset failed: ' + error.message);
                })
                .resetAssessmentTitlesByLevel(level, teacherType);
        }

        // Assessment Title Manager Functions
        function openAssessmentTitleManager() {
            console.log('openAssessmentTitleManager called');
            document.getElementById('assessmentModal').style.display = 'block';
            resetAssessmentForm();
        }
        
        // Ensure function is available globally with error handling
        try {
            window.openAssessmentTitleManager = openAssessmentTitleManager;
            console.log('✅ openAssessmentTitleManager registered successfully');
        } catch (error) {
            console.error('❌ Failed to register openAssessmentTitleManager:', error);
        }
        
        function closeAssessmentModal() {
            document.getElementById('assessmentModal').style.display = 'none';
            resetAssessmentForm();
        }
        
        function resetAssessmentForm() {
            document.getElementById('classSelect').value = '';
            document.querySelectorAll('input[name="subject"]').forEach(radio => radio.checked = false);
            document.getElementById('assessmentSelect').value = '';
            document.getElementById('newTitle').value = '';
            hideAssessmentResult();
        }
        
        function updateAssessmentTitle() {
            // Get form values
            const className = document.getElementById('classSelect').value;
            const subjectRadios = document.querySelectorAll('input[name="subject"]:checked');
            const assessmentCode = document.getElementById('assessmentSelect').value;
            const newTitle = document.getElementById('newTitle').value.trim();
            
            // Validation
            if (!className) {
                showAssessmentError('Please select a class | 請選擇班級');
                return;
            }
            
            if (subjectRadios.length === 0) {
                showAssessmentError('Please select a subject | 請選擇科目');
                return;
            }
            
            const subjectType = subjectRadios[0].value;
            
            if (!assessmentCode) {
                showAssessmentError('Please select an assessment | 請選擇評量');
                return;
            }
            
            if (!newTitle) {
                showAssessmentError('Please enter a new title | 請輸入新標題');
                return;
            }
            
            // Show loading
            showAssessmentResult('🔄 Updating assessment title... | 正在更新評量標題...', 'loading');
            
            // Call the backend function
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showAssessmentResult(
                            `✅ Successfully updated! | 更新成功！<br><br>` +
                            `<strong>Class | 班級:</strong> ${className}<br>` +
                            `<strong>Subject | 科目:</strong> ${subjectType}<br>` +
                            `<strong>Assessment | 評量:</strong> ${assessmentCode}<br>` +
                            `<strong>New Title | 新標題:</strong> ${newTitle}<br><br>` +
                            `<strong>Updated Teachers | 已更新的老師:</strong><br>` +
                            `${result.details || 'Update completed successfully | 更新完成'}`,
                            'success'
                        );
                    } else {
                        showAssessmentResult(`❌ Error | 錯誤: ${result.error}`, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    showAssessmentResult(`❌ System error | 系統錯誤: ${error.message}`, 'error');
                })
                .updateSingleClassAssessment(className, subjectType, assessmentCode, newTitle);
        }
        
        function showAssessmentResult(message, type) {
            const resultDiv = document.getElementById('assessment-result');
            resultDiv.innerHTML = message;
            resultDiv.className = 'result-section';
            
            if (type === 'success') {
                resultDiv.classList.add('result-success');
            } else if (type === 'error') {
                resultDiv.classList.add('result-error');
            }
            
            resultDiv.style.display = 'block';
        }
        
        function showAssessmentError(message) {
            showAssessmentResult(message, 'error');
        }
        
        function hideAssessmentResult() {
            document.getElementById('assessment-result').style.display = 'none';
        }
        
        // ===== PROGRESS AUDIT FUNCTIONS | 進度稽核函數 =====
        
        // Open Progress Audit Modal
        function openProgressAudit() {
            console.log('openProgressAudit called');
            document.getElementById('progressAuditModal').style.display = 'block';
            resetProgressAuditForm();
            // Default to G1 tab
            switchProgressTab('G1');
        }
        
        // Ensure function is available globally with error handling
        try {
            window.openProgressAudit = openProgressAudit;
            console.log('✅ openProgressAudit registered successfully');
        } catch (error) {
            console.error('❌ Failed to register openProgressAudit:', error);
        }
        
        // Close Progress Audit Modal
        function closeProgressAuditModal() {
            document.getElementById('progressAuditModal').style.display = 'none';
            resetProgressAuditForm();
        }
        
        // Reset Progress Audit Form
        function resetProgressAuditForm() {
            // Reset checkpoint name
            document.getElementById('checkpointName').value = '';
            
            // Reset all checkboxes
            document.querySelectorAll('.progress-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear results
            document.getElementById('progress-audit-results').innerHTML = '';
            document.getElementById('progress-audit-results').style.display = 'none';
        }
        
        // Switch between grade level tabs
        function switchProgressTab(grade) {
            // Update active tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${grade}-tab`).style.display = 'block';
        }
        
        // Run Progress Audit
        function runProgressAudit() {
            const checkpointName = document.getElementById('checkpointName').value.trim();
            
            // Validation
            if (!checkpointName) {
                showProgressAuditError('Please enter a checkpoint name | 請輸入檢查點名稱');
                return;
            }
            
            // Collect checkpoint configuration for all grades
            const checkpointConfig = {
                name: checkpointName,
                timestamp: new Date().toISOString(),
                requirements: {}
            };
            
            // Collect requirements for each grade level (G1-G6)
            const grades = ['G1', 'G2', 'G3', 'G4', 'G5', 'G6'];
            let hasAnyRequirements = false;
            
            grades.forEach(grade => {
                const levelGroups = [`${grade}E1`, `${grade}E2`, `${grade}E3`];
                
                levelGroups.forEach(levelGroup => {
                    const formativeRequirements = [];
                    const summativeRequirements = [];
                    
                    // Collect formative requirements (F.A.1 to F.A.8)
                    for (let i = 1; i <= 8; i++) {
                        const checkbox = document.getElementById(`fa-${levelGroup}-${i}`);
                        if (checkbox && checkbox.checked) {
                            formativeRequirements.push(`F.A.${i}`);
                        }
                    }
                    
                    // Collect summative requirements (S.A.1 to S.A.4)
                    for (let i = 1; i <= 4; i++) {
                        const checkbox = document.getElementById(`sa-${levelGroup}-${i}`);
                        if (checkbox && checkbox.checked) {
                            summativeRequirements.push(`S.A.${i}`);
                        }
                    }
                    
                    if (formativeRequirements.length > 0 || summativeRequirements.length > 0) {
                        checkpointConfig.requirements[levelGroup] = {
                            formative: formativeRequirements,
                            summative: summativeRequirements
                        };
                        hasAnyRequirements = true;
                    }
                });
            });
            
            if (!hasAnyRequirements) {
                showProgressAuditError('Please select at least one assessment requirement | 請至少選擇一個評量要求');
                return;
            }
            
            // Show loading
            showProgressAuditLoading();
            
            // Call backend function
            google.script.run
                .withSuccessHandler(handleProgressAuditSuccess)
                .withFailureHandler(handleProgressAuditError)
                .performProgressAudit(checkpointConfig);
        }
        
        // Handle successful progress audit
        function handleProgressAuditSuccess(result) {
            hideProgressAuditLoading();
            
            if (result.success) {
                displayProgressAuditResults(result);
                showProgressAuditSuccess('Progress audit completed successfully | 進度稽核已完成');
            } else {
                showProgressAuditError(`Audit failed: ${result.message} | 稽核失敗：${result.message}`);
            }
        }
        
        // Handle progress audit error
        function handleProgressAuditError(error) {
            hideProgressAuditLoading();
            showProgressAuditError(`Audit error: ${error.message} | 稽核錯誤：${error.message}`);
        }
        
        // Display progress audit results
        function displayProgressAuditResults(result) {
            const resultsDiv = document.getElementById('progress-audit-results');
            
            let html = `
                <div class="progress-audit-summary">
                    <h4><i class="fas fa-chart-line"></i> Progress Audit Report | 進度稽核報告</h4>
                    <div class="audit-meta">
                        <p><strong>Checkpoint:</strong> ${result.checkpointName}</p>
                        <p><strong>Audit Date:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                        <p><strong>Teachers Analyzed:</strong> ${result.teacherCount}</p>
                        <p><strong>Overall Completion:</strong> ${result.overallCompletion}%</p>
                    </div>
                </div>`;
                
            // Add diagnostic information if available
            if (result.diagnostics) {
                html += `
                    <div class="diagnostic-section">
                        <h5><i class="fas fa-stethoscope"></i> System Diagnostics | 系統診斷</h5>
                        <div class="diagnostic-details">
                            <h6>Execution Steps | 執行步驟:</h6>
                            <ul class="diagnostic-steps">`;
                
                result.diagnostics.steps.forEach(step => {
                    const isError = step.includes('❌');
                    const isWarning = step.includes('⚠️');
                    const cssClass = isError ? 'error-step' : isWarning ? 'warning-step' : 'success-step';
                    html += `<li class="${cssClass}">${step}</li>`;
                });
                
                html += `</ul>`;
                
                // Master Data Information
                if (result.diagnostics.masterData) {
                    html += `
                        <h6>Master Data Status | 主控資料狀態:</h6>
                        <ul>
                            <li><strong>Found:</strong> ${result.diagnostics.masterData.found ? '✅ Yes' : '❌ No'}</li>`;
                    if (result.diagnostics.masterData.name) {
                        html += `<li><strong>File Name:</strong> ${result.diagnostics.masterData.name}</li>`;
                    }
                    if (result.diagnostics.masterData.error) {
                        html += `<li class="error-step"><strong>Error:</strong> ${result.diagnostics.masterData.error}</li>`;
                    }
                    html += `</ul>`;
                }
                
                // Teacher Extraction Information  
                if (result.diagnostics.teacherExtraction) {
                    html += `
                        <h6>Teacher Extraction | 教師提取:</h6>
                        <ul>
                            <li><strong>Teachers Found:</strong> ${result.diagnostics.teacherExtraction.count || 0}</li>`;
                    if (result.diagnostics.teacherExtraction.teachers && result.diagnostics.teacherExtraction.teachers.length > 0) {
                        html += `<li><strong>Teacher List:</strong> ${result.diagnostics.teacherExtraction.teachers.join(', ')}</li>`;
                    }
                    html += `</ul>`;
                }
                
                // Errors
                if (result.diagnostics.errors && result.diagnostics.errors.length > 0) {
                    html += `
                        <h6>Errors Encountered | 遇到的錯誤:</h6>
                        <ul class="error-list">`;
                    result.diagnostics.errors.forEach(error => {
                        html += `<li class="error-step">${error}</li>`;
                    });
                    html += `</ul>`;
                }
                
                html += `</div></div>`;
            }
                
                <div class="progress-results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Teacher | 教師</th>
                                <th>Level Groups | 分級</th>
                                <th>Formative | 形成性</th>
                                <th>Summative | 總結性</th>
                                <th>Overall | 整體</th>
                                <th>Status | 狀態</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            result.teacherResults.forEach(teacher => {
                const statusColor = teacher.overallCompletion >= 90 ? '#4caf50' : 
                                  teacher.overallCompletion >= 80 ? '#ff9800' : 
                                  teacher.overallCompletion >= 60 ? '#ff5722' : '#f44336';
                
                const statusIcon = teacher.overallCompletion >= 90 ? '🟢' : 
                                 teacher.overallCompletion >= 80 ? '🟡' : 
                                 teacher.overallCompletion >= 60 ? '🟠' : '🔴';
                
                html += `
                    <tr>
                        <td><strong>${teacher.name}</strong></td>
                        <td>${teacher.levelGroups.join(', ')}</td>
                        <td>${teacher.formativeCompletion}%</td>
                        <td>${teacher.summativeCompletion}%</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${teacher.overallCompletion}%</td>
                        <td>${statusIcon}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add detailed breakdown if available
            if (result.levelGroupBreakdown) {
                html += `
                    <div class="level-group-breakdown">
                        <h5><i class="fas fa-list-alt"></i> Level Group Breakdown | 分級詳細分析</h5>
                `;
                
                Object.entries(result.levelGroupBreakdown).forEach(([levelGroup, data]) => {
                    html += `
                        <div class="level-group-item">
                            <h6>${levelGroup}</h6>
                            <p>Completion: ${data.completion}% | Teachers: ${data.teacherCount}</p>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // Show progress audit loading
        function showProgressAuditLoading() {
            document.getElementById('progress-audit-loading').style.display = 'block';
        }
        
        // Hide progress audit loading
        function hideProgressAuditLoading() {
            document.getElementById('progress-audit-loading').style.display = 'none';
        }
        
        // Show progress audit success message
        function showProgressAuditSuccess(message) {
            showProgressAuditMessage(message, 'success');
        }
        
        // Show progress audit error message
        function showProgressAuditError(message) {
            showProgressAuditMessage(message, 'error');
        }
        
        // Show progress audit message
        function showProgressAuditMessage(message, type) {
            const messageDiv = document.getElementById('progress-audit-message');
            messageDiv.textContent = message;
            messageDiv.className = `progress-audit-message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const assessmentModal = document.getElementById('assessmentModal');
            const progressModal = document.getElementById('progressAuditModal');
            
            if (event.target === assessmentModal) {
                closeAssessmentModal();
            } else if (event.target === progressModal) {
                closeProgressAuditModal();
            }
        }
        
        // Final function validation and registration
        function ensureGlobalFunctions() {
            const functions = [
                { name: 'openProgressAudit', func: openProgressAudit },
                { name: 'openAssessmentTitleManager', func: openAssessmentTitleManager }
            ];
            
            functions.forEach(({name, func}) => {
                if (typeof func === 'function') {
                    window[name] = func;
                    console.log(`✅ ${name} registered globally`);
                } else {
                    console.error(`❌ ${name} is not a function:`, typeof func);
                }
            });
        }

        // Confirm script loaded successfully
        console.log('Dashboard script loaded successfully!');
        ensureGlobalFunctions();
        
        // Final verification
        console.log('Final function availability:', {
            openProgressAudit: typeof window.openProgressAudit,
            openAssessmentTitleManager: typeof window.openAssessmentTitleManager,
            windowFunctions: Object.keys(window).filter(key => key.startsWith('open'))
        });

    </script>
</body>
</html>