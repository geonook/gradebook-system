<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradebook System Dashboard | 成績簿系統控制台</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            font-size: 2rem;
            margin-right: 15px;
            padding: 15px;
            border-radius: 10px;
            color: white;
        }

        .system-status .card-icon { background: #4CAF50; }
        .quick-stats .card-icon { background: #2196F3; }
        .system-controls .card-icon { background: #FF9800; }
        .progress-overview .card-icon { background: #9C27B0; }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #666;
        }

        .stat-value {
            font-weight: 600;
            color: #333;
            padding: 5px 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
        }

        .btn-secondary:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Assessment Title Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 0;
            border: none;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .class-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .class-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .class-info h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }

        .class-info p {
            margin: 5px 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .assessment-section {
            margin-bottom: 20px;
        }

        .assessment-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1rem;
        }

        .assessment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .assessment-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .assessment-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .btn-update {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn-update:hover {
            background: #0056b3;
        }

        .btn-reset {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .btn-reset:hover {
            background: #c82333;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 0 10px;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-excellent { background: #4CAF50; }
        .status-good { background: #FFC107; }
        .status-warning { background: #FF9800; }
        .status-error { background: #f44336; }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .bilingual {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📊 Gradebook System Dashboard</h1>
            <p>Educational grade management system</p>
            <div class="bilingual">Complete Google-based gradebook solution</div>
        </div>

        <!-- Alert Messages -->
        <div id="alert-success" class="alert alert-success"></div>
        <div id="alert-error" class="alert alert-error"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- System Status Card -->
            <div class="card system-status">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div>
                        <div class="card-title">System Status</div>
                        <div class="bilingual">Real-time system health monitoring</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">System Health</span>
                    <span class="stat-value">
                        <span class="status-indicator status-excellent"></span>
                        Excellent
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Updated</span>
                    <span class="stat-value" id="last-updated">Loading...</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Semester</span>
                    <span class="stat-value">2425S2</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Version</span>
                    <span class="stat-value">Dashboard v3.0</span>
                </div>
            </div>

            <!-- Quick Statistics Card -->
            <div class="card quick-stats">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div>
                        <div class="card-title">Quick Statistics</div>
                        <div class="bilingual">Real-time system metrics</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Teachers</span>
                    <span class="stat-value" id="total-teachers">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Students</span>
                    <span class="stat-value" id="total-students">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Active Gradebooks</span>
                    <span class="stat-value" id="active-gradebooks">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">System Files</span>
                    <span class="stat-value" id="system-files">0</span>
                </div>
            </div>

            <!-- System Controls Card -->
            <div class="card system-controls">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <div class="card-title">System Controls</div>
                        <div class="bilingual">One-click system management</div>
                    </div>
                </div>
                <div class="control-grid">
                    <button class="btn btn-primary" onclick="initializeSystem()">
                        <i class="fas fa-rocket"></i> Initialize
                    </button>
                    <button class="btn btn-secondary" onclick="checkSystemStatus()">
                        <i class="fas fa-stethoscope"></i> Check Status
                    </button>
                    <button class="btn btn-warning" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-secondary" onclick="openSystemFolder()">
                        <i class="fas fa-folder-open"></i> System Folder
                    </button>
                    <button class="btn btn-secondary" onclick="openMasterData()">
                        <i class="fas fa-database"></i> Master Data
                    </button>
                    <button class="btn btn-warning" onclick="updateTeachers()">
                        <i class="fas fa-sync-alt"></i> Update Teachers
                    </button>
                    <button class="btn btn-secondary" onclick="updateStudentStatus()">
                        <i class="fas fa-user-check"></i> Update Status
                    </button>
                    <button class="btn btn-info" onclick="validateClassAssignments()">
                        <i class="fas fa-check-circle"></i> Validate Classes
                    </button>
                    <button class="btn btn-success" onclick="manageAssessmentTitles()">
                        <i class="fas fa-tags"></i> Assessment Titles
                    </button>
                    <button class="btn btn-warning" onclick="debugSystem()">
                        <i class="fas fa-bug"></i> Debug
                    </button>
                    <button class="btn btn-info" onclick="checkHeaders()">
                        <i class="fas fa-list"></i> Check Headers
                    </button>
                    <button class="btn btn-success" onclick="testCreation()">
                        <i class="fas fa-flask"></i> Test Creation
                    </button>
                    <button class="btn btn-danger" onclick="systemBackup()">
                        <i class="fas fa-download"></i> Backup
                    </button>
                </div>
            </div>

            <!-- Progress Overview Card -->
            <div class="card progress-overview">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div>
                        <div class="card-title">Progress Overview</div>
                        <div class="bilingual">Teacher progress tracking</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🟢 Excellent (≥90%)</span>
                    <span class="stat-value" id="progress-excellent">0 (0%)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🟡 Good (80-89%)</span>
                    <span class="stat-value" id="progress-good">0 (0%)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🟠 Normal (60-79%)</span>
                    <span class="stat-value" id="progress-normal">0 (0%)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">🔴 Behind (<60%)</span>
                    <span class="stat-value" id="progress-behind">0 (0%)</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 75%;"></div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <small>Overall System Progress: <span id="overall-percentage">75%</span></small>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon" style="background: #607D8B;">
                    <i class="fas fa-bolt"></i>
                </div>
                <div>
                    <div class="card-title">Quick Actions</div>
                    <div class="bilingual">Frequently used system functions</div>
                </div>
            </div>
            <div class="control-grid">
                <button class="btn btn-primary" onclick="batchCreateGradebooks()">
                    <i class="fas fa-plus-circle"></i> Batch Create Gradebooks
                </button>
                <button class="btn btn-secondary" onclick="checkAllProgress()">
                    <i class="fas fa-chart-line"></i> Check All Progress
                </button>
                <button class="btn btn-warning" onclick="generateReport()">
                    <i class="fas fa-file-alt"></i> Generate Report
                </button>
                <button class="btn btn-secondary" onclick="importStudentData()">
                    <i class="fas fa-upload"></i> Import Student Data
                </button>
                <button class="btn btn-secondary" onclick="exportStudentData()">
                    <i class="fas fa-download"></i> Export Student Data
                </button>
                <button class="btn btn-warning" onclick="systemMaintenance()">
                    <i class="fas fa-tools"></i> System Maintenance
                </button>
            </div>
        </div>
    </div>

    <!-- Assessment Title Management Modal -->
    <div id="assessmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-tags"></i> Assessment Title Management</h2>
                <span class="close" onclick="closeAssessmentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="assessment-content">
                    <div style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <p>Loading assessment configurations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isLoading = false;

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateTimestamp();
            loadSystemStatistics();
            setInterval(updateTimestamp, 60000); // Update every minute
        });

        // Update timestamp
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-updated').textContent = now.toLocaleString();
        }

        // Show loading indicator
        function showLoading() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('loading').style.display = 'block';
            hideAlerts();
        }

        // Hide loading indicator
        function hideLoading() {
            isLoading = false;
            document.getElementById('loading').style.display = 'none';
        }

        // Show success message
        function showSuccess(message) {
            const alert = document.getElementById('alert-success');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // Show error message
        function showError(message) {
            const alert = document.getElementById('alert-error');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // Hide all alerts
        function hideAlerts() {
            document.getElementById('alert-success').style.display = 'none';
            document.getElementById('alert-error').style.display = 'none';
        }

        // System Functions
        function initializeSystem() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('✅ System initialized successfully! | 系統初始化成功！');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Initialization failed: ' + error.message + ' | 初始化失敗');
                })
                .initializeSystem();
        }

        function checkSystemStatus() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('🟢 System Status: Healthy | 系統狀態健康');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Status check failed: ' + error.message + ' | 狀態檢查失敗');
                })
                .getSystemStatistics();
        }

        function refreshDashboard() {
            showLoading();
            loadSystemStatistics();
            setTimeout(() => {
                hideLoading();
                showSuccess('✅ Dashboard refreshed successfully!');
            }, 1000);
        }

        function loadSystemStatistics() {
            google.script.run
                .withSuccessHandler(function(stats) {
                    document.getElementById('total-teachers').textContent = stats.totalTeachers || 0;
                    document.getElementById('total-students').textContent = stats.totalStudents || 0;
                    document.getElementById('active-gradebooks').textContent = stats.activeGradebooks || 0;
                    document.getElementById('system-files').textContent = stats.systemFiles || 0;
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load statistics:', error);
                })
                .getSystemStatistics();
        }

        function openSystemFolder() {
            google.script.run
                .withSuccessHandler(function(url) {
                    window.open(url, '_blank');
                    showSuccess('📁 Opening system folder');
                })
                .withFailureHandler(function(error) {
                    showError('❌ Cannot open system folder: ' + error.message);
                })
                .getSystemFolderUrl();
        }

        function openMasterData() {
            google.script.run
                .withSuccessHandler(function(url) {
                    window.open(url, '_blank');
                    showSuccess('📋 Opening master data sheet');
                })
                .withFailureHandler(function(error) {
                    showError('❌ Cannot open master data: ' + error.message);
                })
                .getMasterDataUrl();
        }

        // Batch create gradebooks functionality
        function batchCreateGradebooks() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('🎉 Gradebook creation completed!');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Failed to create gradebooks: ' + error.message);
                })
                .batchCreateGradebooks();
        }

        function checkAllProgress() {
            showSuccess('📈 Progress check feature coming soon!');
        }

        function generateReport() {
            showSuccess('📋 Report generation feature coming soon!');
        }

        function importStudentData() {
            showSuccess('📥 Import feature coming soon!');
        }

        function exportStudentData() {
            showSuccess('📤 Export feature coming soon!');
        }

        function systemBackup() {
            showSuccess('🔄 Backup feature coming soon!');
        }

        function updateTeachers() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('✅ Teachers updated successfully! Found ' + result.length + ' teachers');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Failed to update teachers: ' + error.message);
                })
                .updateAutoGeneratedTeachers();
        }

        function updateStudentStatus() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    showSuccess('✅ Student status updated successfully!');
                    loadSystemStatistics();
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Failed to update student status: ' + error.message);
                })
                .updateStudentStatus();
        }

        function debugSystem() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    let studentSamplesText = '';
                    if (result.studentSamples && result.studentSamples.length > 0) {
                        studentSamplesText = result.studentSamples.map(s => 
                            `• ${s.name || 'empty'} (Status: ${s.status || 'empty'}, Class: ${s.englishClass || 'empty'}, LT: ${s.ltTeacher || 'empty'}, IT: ${s.itTeacher || 'empty'})`
                        ).join('\n');
                    }
                    
                    let teacherSamplesText = '';
                    if (result.teacherSamples && result.teacherSamples.length > 0) {
                        teacherSamplesText = result.teacherSamples.map(t => 
                            `• ${t.name} (${t.subject}) - Classes: ${t.classes}`
                        ).join('\n');
                    }
                    
                    const debugInfo = `
🔍 System Debug Results:

📁 System Folder: ${result.systemFolder}
📋 Master Data Sheet: ${result.masterDataSheet}  
👥 Students Data: ${result.studentsData} total records
📝 Students with "在學" status: ${result.studentsWithStatus}
👨‍🏫 Teachers Found: ${result.teachersFound}
📊 Gradebooks Folder: ${result.teacherGradebooksFolder}

📄 Student Samples (first 5):
${studentSamplesText || 'No student data found'}

👩‍🏫 Teacher Samples:
${teacherSamplesText || 'No teacher data found'}

${result.error ? '❌ Error: ' + result.error : '✅ No errors detected'}
                    `;
                    showSuccess(debugInfo);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Debug failed: ' + error.message);
                })
                .debugSystemStatus();
        }

        function checkHeaders() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    let headersText = '';
                    if (result.headers) {
                        headersText = result.headers.map((header, index) => 
                            `${index + 1}. "${header}"`
                        ).join('\n');
                    }
                    
                    let indicesText = '';
                    if (result.columnIndices) {
                        indicesText = Object.entries(result.columnIndices).map(([col, index]) => 
                            `"${col}": ${index === -1 ? 'NOT FOUND' : 'Column ' + (index + 1)}`
                        ).join('\n');
                    }
                    
                    let sampleRowText = '';
                    if (result.sampleRow) {
                        sampleRowText = result.sampleRow.map((value, index) => 
                            `${index + 1}. ${value || 'empty'}`
                        ).join('\n');
                    }
                    
                    const headerInfo = `
📋 Column Headers Check:

📊 Total Columns: ${result.columnCount}
📄 Data Rows: ${result.dataRows}

🔍 All Headers:
${headersText}

🎯 Key Column Indices:
${indicesText}

📝 Sample Row Data:
${sampleRowText}

${result.error ? '❌ Error: ' + result.error : '✅ Headers checked successfully'}
                    `;
                    showSuccess(headerInfo);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Header check failed: ' + error.message);
                })
                .checkColumnHeaders();
        }

        function testCreation() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.error) {
                        showError('❌ Test failed: ' + result.error);
                        return;
                    }
                    
                    let assignmentText = '';
                    if (result && result.length > 0) {
                        assignmentText = result.map(assignment => 
                            `🏫 ${assignment.teacher} (${assignment.subject})
   📚 Class: ${assignment.class}
   👥 Students (${assignment.studentCount}): ${assignment.studentNames.join(', ')}`
                        ).join('\n\n');
                    }
                    
                    const testInfo = `
🧪 Gradebook Creation Test:

${assignmentText || 'No valid assignments found'}

${result.length === 0 ? '⚠️ No students were assigned to any teachers!' : '✅ Student assignments look correct!'}
                    `;
                    showSuccess(testInfo);
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Test failed: ' + error.message);
                })
                .testGradebookCreation();
        }

        function validateClassAssignments() {
            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.isValid) {
                        showSuccess(`✅ Class assignments validation passed!\n\nDefined classes: ${result.definedClasses.length}\nNo assignment conflicts found.`);
                    } else {
                        let message = `⚠️ Class assignment validation issues found:\n\n`;
                        message += `Issues (${result.issues.length}):\n`;
                        result.issues.slice(0, 10).forEach(issue => {
                            message += `• ${issue}\n`;
                        });
                        if (result.issues.length > 10) {
                            message += `• ... and ${result.issues.length - 10} more issues\n`;
                        }
                        message += `\nUndefined classes: ${result.undefinedClasses.join(', ')}\n`;
                        message += `\nPlease update Students sheet to match Classes sheet definitions.`;
                        showError(message);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Validation failed: ' + error.message);
                })
                .validateStudentClassAssignments();
        }

        function systemMaintenance() {
            showSuccess('🔧 Maintenance feature coming soon!');
        }

        // Assessment Title Management Functions
        function manageAssessmentTitles() {
            document.getElementById('assessmentModal').style.display = 'block';
            loadAssessmentTitles();
        }

        function closeAssessmentModal() {
            document.getElementById('assessmentModal').style.display = 'none';
        }

        function loadAssessmentTitles() {
            const content = document.getElementById('assessment-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>Loading assessment configurations...</p>
                </div>
            `;

            google.script.run
                .withSuccessHandler(function(data) {
                    renderAssessmentTitles(data);
                })
                .withFailureHandler(function(error) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: red;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                            <h3>❌ Failed to load assessment titles</h3>
                            <p>Failed to load assessment titles: ${error.message}</p>
                        </div>
                    `;
                })
                .getAllAssessmentTitlesForDashboard();
        }

        function renderAssessmentTitles(data) {
            const content = document.getElementById('assessment-content');
            
            if (!data || data.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-info-circle" style="font-size: 3rem; color: #ffc107; margin-bottom: 20px;"></i>
                        <h3>No class configurations found</h3>
                        <p>Please configure class data in the master sheet first</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="margin-bottom: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px;">
                    <h3 style="margin: 0 0 10px 0; color: #1976d2;">
                        <i class="fas fa-info-circle"></i> How to Use
                    </h3>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li>Each grade has 3 levels: E1 (Basic), E2 (Intermediate), E3 (Advanced)</li>
                        <li>Modify assessment titles below and click "Update" to save changes</li>
                        <li>Click "Reset" to restore default titles for a class</li>
                        <li>Changes take effect immediately for new gradebooks</li>
                    </ul>
                </div>
            `;

            // Group by grade
            const groupedData = {};
            data.forEach(classConfig => {
                if (!groupedData[classConfig.grade]) {
                    groupedData[classConfig.grade] = [];
                }
                groupedData[classConfig.grade].push(classConfig);
            });

            // Render each grade
            Object.keys(groupedData).sort().forEach(grade => {
                html += `<h3 style="margin: 30px 0 20px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                    <i class="fas fa-graduation-cap"></i> ${grade} Classes
                </h3>`;

                groupedData[grade].forEach(classConfig => {
                    html += createClassCard(classConfig);
                });
            });

            content.innerHTML = html;
        }

        function createClassCard(classConfig) {
            const formativeTitles = classConfig.formativeTitles || [];
            const summativeTitles = classConfig.summativeTitles || [];
            
            return `
                <div class="class-card">
                    <div class="class-header">
                        <div class="class-info">
                            <h3>${classConfig.className}</h3>
                            <p><strong>Level:</strong> ${classConfig.level} | <strong>LT:</strong> ${classConfig.ltTeacher || 'N/A'} | <strong>IT:</strong> ${classConfig.itTeacher || 'N/A'} | <strong>Students:</strong> ${classConfig.studentCount || '0'}</p>
                        </div>
                        <div>
                            <button class="btn-update" onclick="updateClassAssessmentTitles('${classConfig.classCode}')">
                                <i class="fas fa-save"></i> Update
                            </button>
                            <button class="btn-reset" onclick="resetClassAssessmentTitles('${classConfig.classCode}')">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                    
                    <div class="assessment-section">
                        <h4><i class="fas fa-pencil-alt" style="color: #2196f3;"></i> Formative Assessments (8 items)</h4>
                        <div class="assessment-grid">
                            ${formativeTitles.map((title, index) => 
                                `<input type="text" class="assessment-input" 
                                        id="formative-${classConfig.classCode}-${index}" 
                                        value="${title}" 
                                        placeholder="F.A.${index + 1}">`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="assessment-section">
                        <h4><i class="fas fa-chart-bar" style="color: #4caf50;"></i> Summative Assessments (4 items)</h4>
                        <div class="assessment-grid">
                            ${summativeTitles.map((title, index) => 
                                `<input type="text" class="assessment-input" 
                                        id="summative-${classConfig.classCode}-${index}" 
                                        value="${title}" 
                                        placeholder="S.A.${index + 1}">`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function updateClassAssessmentTitles(classCode) {
            // Collect formative titles
            const formativeTitles = [];
            for (let i = 0; i < 8; i++) {
                const input = document.getElementById(`formative-${classCode}-${i}`);
                formativeTitles.push(input ? input.value.trim() : `F.A.${i + 1}`);
            }

            // Collect summative titles
            const summativeTitles = [];
            for (let i = 0; i < 4; i++) {
                const input = document.getElementById(`summative-${classCode}-${i}`);
                summativeTitles.push(input ? input.value.trim() : `S.A.${i + 1}`);
            }

            // Validate inputs
            if (formativeTitles.some(title => !title) || summativeTitles.some(title => !title)) {
                showError('❌ All fields must be filled');
                return;
            }

            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        let message = `✅ ${result.message}`;
                        if (result.warnings && result.warnings.length > 0) {
                            message += `\n⚠️ Some issues occurred during synchronization:\n${result.warnings.join('\n')}`;
                        }
                        showSuccess(message);
                    } else {
                        showError(`❌ Failed to update ${classCode}: ${result.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Update failed: ' + error.message);
                })
                .updateAssessmentTitlesByClassCode(classCode, formativeTitles, summativeTitles);
        }

        function resetClassAssessmentTitles(classCode) {
            if (!confirm(`Are you sure you want to reset assessment titles for ${classCode}? This will restore default titles.`)) {
                return;
            }

            showLoading();
            google.script.run
                .withSuccessHandler(function(result) {
                    hideLoading();
                    if (result.success) {
                        let message = `✅ ${result.message}`;
                        if (result.warnings && result.warnings.length > 0) {
                            message += `\n⚠️ Some issues occurred during synchronization:\n${result.warnings.join('\n')}`;
                        }
                        showSuccess(message);
                        loadAssessmentTitles(); // Reload to show default titles
                    } else {
                        showError(`❌ Failed to reset ${classCode}: ${result.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    hideLoading();
                    showError('❌ Reset failed: ' + error.message);
                })
                .resetAssessmentTitles(classCode);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('assessmentModal');
            if (event.target === modal) {
                closeAssessmentModal();
            }
        }
    </script>
</body>
</html>